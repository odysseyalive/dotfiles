#!/usr/bin/env bash
# This script is just a personal snapshot of my arch workstation.
# curl https://raw.githubusercontent.com/bridgesense/dotfiles/master/workstation/endeavouros-gemini > ~/install
# NOTE: There are additional settings under the troublehsooting section.
# bash install
# # # # # # # # # # # # # # #

# Options
# # # # # # # # # # # # # # #
# USER="${1:francis}"
LOGFILE='workstation-installation.log'

# Functions
# # # # # # # # # # # # # # #
function log {
  if [ -f "$LOGFILE" ]; then
    echo $1 >>$LOGFILE
  else
    echo $1 >$LOGFILE
  fi
}

function install {
  arr=("$@")
  _type=
  if [[ "$(declare -p arr)" =~ "declare -a" ]]; then
    for package in "${arr[@]}"; do
      if [[ $package == "package" ]]; then
        _type=$package
        continue
      fi
      if [[ $package == "flatpak" ]]; then
        _type=$package
        continue
      fi
      cnt=3
      pacname=$(echo $package | sed 's/^[^/]*\///')
      while [ $cnt -gt 0 ]; do
        if pacman -Qqe | grep $pacname; then
          break
        else
          if [[ $_type == "flatpak" ]]; then
            flatpak install flathub --noninteractive -y $package
            break
          else
            yay -S --noconfirm $package
          fi
        fi
        let "cnt-=1"
      done
      if ! pacman -Qqe | grep $pacname && [[ $_type != "flatpak" ]]; then
        log "There was a problem installing ${package}.  Please make sure this package exists."
      fi
    done
  else
    log "Warning! Passed variable is not an array".
  fi
}

log "installing commandline tools"
yay --noconfirm
install package extra/ranger
install package extra/kitty
install package aur/insync
install package extra/tmux
install package extra/virtualbox
install pacakge extra/audacity
install package omarchy/lmstudio
install pacakge extra/virtualbox-host-modules-arch
install package extra/telegram-desktop
install package extra/podman extra/buildah
install package extra/krita-plugin-gmic
install package extra/rsync
install package extra/lsof extra/strace
install package extra/gdb extra/ltrace
install package extra/htop extra/tree
install package extra/bind extra/openbsd-netcat extra/traceroute
install package extra/pdfarranger
install package aur/dosbox-staging
install package extra/nvidia extra/nvidia-settings extra/cuda
install package multilib/lib32-mesa multilib/lib32-vulkan-intel multilib/lib32-vulkan-radeon multilib/lib32-nvidia-utils
install package extra/gst-plugins-good extra/gst-plugins-bad extra/gst-plugins-ugly extra/gst-libav
install package extra/wine-staging multilib/winetricks
install package extra/git-lfs
install package extra/fs-uae
install package extra/tesseract extra/tesseract-data-eng
install package aur/inform7-ide aur/lectorte-bin
install package aur/hplip-plugin
install package aur/ghostty-git
install package extra/ttf-cascadia-code-nerd
install package extra/zoxide
install package extra/zsh
install package aur/google-chrome
install package aur/python-azure-cognitiveservices-speech

# interactive fiction tools
# install package aur/inform7-ide-git
# install package aur/lectrote-bin

# codecs
install package extra/libaacs
install package extra/cdrtools extra/cdrdao extra/dvd+rw-tools

# syncterm
# NOTE: Had some issues with aur version
# thanks to MeaTLoTioN for this alternative script
# https://www.erb.pw/how-to-install-syncterm-for-linux-from-source/
mkdir -p ~/lab
cd ~/lab
curl -s https://erb.pw/get-syncterm.sh | bash

# Installing configuration
# # # # # # # # # # # # # # #
log "installing custom configuration"
bash -c "$(curl -fsSL https://raw.githubusercontent.com/odysseyalive/dotfiles/master/setup)"
bash ~/.yadrlite/setup omarchy

# Configure Starship prompt
log "configuring starship prompt"
mkdir -p ~/.config
cat >~/.config/starship.toml <<'EOF'
add_newline = true
command_timeout = 500
format = """
$directory
$username$time$git_branch$git_status$character"""

[character]
error_symbol = "[✗](bold red)"
success_symbol = "[❯](bold green)"

[directory]
truncation_length = 100
truncate_to_repo = false
style = "bold blue"
format = "[$path]($style)[$read_only]($read_only_style)"

[git_branch]
format = "[$symbol$branch]($style) "
style = "italic magenta"
symbol = ""

[git_status]
format = '[$all_status]($style)'
style = "yellow"
ahead = "⇡${count} "
diverged = "⇕⇡${ahead_count}⇣${behind_count} "
behind = "⇣${count} "
conflicted = " "
up_to_date = " "
untracked = "? "
modified = " "
stashed = ""
staged = ""
renamed = ""
deleted = ""

[username]
format = "[$user]($style) "
style_user = "bold green"
show_always = true

[time]
disabled = false
format = "[$time]($style) "
style = "bold cyan"
time_format = "%T"
EOF

# Configure Hyprland keyboard options
log "configuring hyprland keyboard settings"
if [ -f ~/.config/hypr/input.conf ]; then
  sed -i 's/^[[:space:]]*kb_options[[:space:]]*=.*/  kb_options = caps:swapescape/' ~/.config/hypr/input.conf
  # Reload Hyprland configuration if running
  if pgrep -x "Hyprland" >/dev/null; then
    hyprctl reload
    log "hyprland configuration reloaded"
  fi
fi

# Configure Hyprland Nvidia environment variables
log "configuring hyprland nvidia environment variables"
if [ -f ~/.config/hypr/hyprland.conf ]; then
  # Check if env variables are already set
  if ! grep -q "LIBVA_DRIVER_NAME,nvidia" ~/.config/hypr/hyprland.conf; then
    # Add Nvidia env variables at the beginning of the file
    sed -i '1i\# Nvidia environment variables\nenv = LIBVA_DRIVER_NAME,nvidia\nenv = GBM_BACKEND,nvidia-drm\nenv = __GLX_VENDOR_LIBRARY_NAME,nvidia\nenv = NVD_BACKEND,direct\n' ~/.config/hypr/hyprland.conf
    log "nvidia environment variables added to hyprland.conf"
    # Reload Hyprland configuration if running
    if pgrep -x "Hyprland" >/dev/null; then
      hyprctl reload
      log "hyprland configuration reloaded for nvidia settings"
    fi
  else
    log "nvidia environment variables already present in hyprland.conf"
  fi
fi

# improve sound
mkdir -p ~/.config/pipewire/pipewire.conf.d
printf "context.properties = {\n\
  default.clock.rate = 192000\n\
  default.clock.allowed-rates = [ 44100 48000 88200 96000 192000 352800 384000]\n\
}\n\
stream.properties = {\n\
  resample.quality = 10\n\
  channelmix.max-volume = 2.0\n\
}\n\
" >>~/.config/pipewire/pipewire.conf.d/10-rates.conf

# disables audio suspend for pipewire bug
mkdir -p ~/.config/wireplumber/main.lua.d/
cat >~/.config/wireplumber/main.lua.d/50-alsa-config.lua <<'EOF'
-- Disable suspend-on-idle for all audio devices
alsa_monitor.rules = {
  {
    matches = {
      {
        { "node.name", "matches", "alsa_output.*" },
      },
      {
        { "node.name", "matches", "alsa_input.*" },
      },
    },
    apply_properties = {
      ["session.suspend-timeout-seconds"] = 0,
    },
  },
}
EOF
sudo systemctl --user restart wireplumber

# configure swayosd max volume
mkdir -p ~/.config/swayosd
cat >~/.config/swayosd/config.toml <<'EOF'
[server]
show_percentage = true
max_volume = 200
style = "./style.css"
EOF

# install global volume control script (affects ALL sinks and apps)
log "installing global volume control script"
mkdir -p ~/.local/bin
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
if [ -f "$SCRIPT_DIR/workstation/scripts/omarchy-volume" ]; then
  cp "$SCRIPT_DIR/workstation/scripts/omarchy-volume" ~/.local/bin/omarchy-volume
elif [ -f ~/.yadrlite/workstation/scripts/omarchy-volume ]; then
  cp ~/.yadrlite/workstation/scripts/omarchy-volume ~/.local/bin/omarchy-volume
else
  # Create the script inline if not found
  cat >~/.local/bin/omarchy-volume <<'VOLSCRIPT'
#!/bin/bash
# Global volume control - affects ALL sinks and streams simultaneously

ACTION="$1"
AMOUNT="${2:-5}"
MAX_VOLUME="${3:-200}"

get_all_sinks() {
    pactl list short sinks | awk '{print $1}'
}

get_all_sink_inputs() {
    pactl list short sink-inputs | awk '{print $1}'
}

get_current_volume() {
    pactl list sinks | grep -E "^\s+Volume:" | head -1 | grep -oP '\d+%' | head -1 | tr -d '%'
}

set_volume_all() {
    local vol="$1"
    if [ "$vol" -gt "$MAX_VOLUME" ]; then
        vol="$MAX_VOLUME"
    elif [ "$vol" -lt 0 ]; then
        vol=0
    fi
    for sink in $(get_all_sinks); do
        pactl set-sink-volume "$sink" "${vol}%"
    done
    for input in $(get_all_sink_inputs); do
        pactl set-sink-input-volume "$input" "${vol}%"
    done
    echo "$vol"
}

case "$ACTION" in
    raise|up|+)
        current=$(get_current_volume)
        new=$((current + AMOUNT))
        set_volume_all "$new"
        ;;
    lower|down|-)
        current=$(get_current_volume)
        new=$((current - AMOUNT))
        set_volume_all "$new"
        ;;
    mute-toggle|toggle)
        for sink in $(get_all_sinks); do
            pactl set-sink-mute "$sink" toggle
        done
        for input in $(get_all_sink_inputs); do
            pactl set-sink-input-mute "$input" toggle
        done
        ;;
    set)
        set_volume_all "$AMOUNT"
        ;;
    get)
        get_current_volume
        ;;
    balance)
        for sink in $(get_all_sinks); do
            vol=$(pactl get-sink-volume "$sink" | grep -oP '\d+%' | head -1 | tr -d '%')
            pactl set-sink-volume "$sink" "${vol}%" 2>/dev/null
        done
        for input in $(get_all_sink_inputs); do
            vol=$(pactl get-sink-input-volume "$input" 2>/dev/null | grep -oP '\d+%' | head -1 | tr -d '%')
            [ -n "$vol" ] && pactl set-sink-input-volume "$input" "${vol}%" 2>/dev/null
        done
        echo "Balance fixed"
        ;;
    *)
        echo "Usage: omarchy-volume <raise|lower|mute-toggle|set|get|balance> [amount] [max-volume]"
        exit 1
        ;;
esac
VOLSCRIPT
fi
chmod +x ~/.local/bin/omarchy-volume
log "global volume control script installed"

# configure hyprland volume keys to allow 200% max volume and control ALL sinks/apps
if [ -f ~/.config/hypr/bindings.conf ]; then
  if ! grep -q "omarchy-volume" ~/.config/hypr/bindings.conf; then
    cat >>~/.config/hypr/bindings.conf <<'EOF'

# Volume keys with 200% max volume support - controls ALL sinks/apps globally
$osdclient = swayosd-client --monitor "$(hyprctl monitors -j | jq -r '.[] | select(.focused == true).name')"
bindeld = ,XF86AudioRaiseVolume, Volume up, exec, ~/.local/bin/omarchy-volume raise 3 200 && $osdclient --output-volume raise --max-volume 200
bindeld = ,XF86AudioLowerVolume, Volume down, exec, ~/.local/bin/omarchy-volume lower 3 200 && $osdclient --output-volume lower --max-volume 200
bindeld = ALT, XF86AudioRaiseVolume, Volume up precise, exec, ~/.local/bin/omarchy-volume raise 1 200 && $osdclient --output-volume +1 --max-volume 200
bindeld = ALT, XF86AudioLowerVolume, Volume down precise, exec, ~/.local/bin/omarchy-volume lower 1 200 && $osdclient --output-volume -1 --max-volume 200
EOF
    log "hyprland volume bindings configured for global volume control with 200% max"
  fi
fi

# clean everything
yay -Scc --noconfirm

log "Installation complete.  Please reboot your system."
printf "\r# # # # # # # # # # # # # # # # # # # # # # # # # # # # # #\r"
printf "ALL DONE\r"
printf "Review the workstation-installation.login and address any uninstalled packages noted.\r"
printf "PLEASE REBOOT YOUR SYSTEM."
