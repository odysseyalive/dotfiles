#!/usr/bin/env bash
# This script is just a personal snapshot of my arch workstation.
# curl https://raw.githubusercontent.com/bridgesense/dotfiles/master/workstation/endeavouros-gemini > ~/install
# NOTE: There are additional settings under the troublehsooting section.
# bash install
# # # # # # # # # # # # # # #

# Options
# # # # # # # # # # # # # # #
# USER="${1:francis}"
LOGFILE='workstation-installation.log'

# Functions
# # # # # # # # # # # # # # #
function log {
  if [ -f "$LOGFILE" ]; then
    echo $1 >>$LOGFILE
  else
    echo $1 >$LOGFILE
  fi
}

function install {
  arr=("$@")
  _type=
  if [[ "$(declare -p arr)" =~ "declare -a" ]]; then
    for package in "${arr[@]}"; do
      if [[ $package == "package" ]]; then
        _type=$package
        continue
      fi
      if [[ $package == "flatpak" ]]; then
        _type=$package
        continue
      fi
      cnt=3
      pacname=$(echo $package | sed 's/^[^/]*\///')
      while [ $cnt -gt 0 ]; do
        if pacman -Qqe | grep $pacname; then
          break
        else
          if [[ $_type == "flatpak" ]]; then
            flatpak install flathub --noninteractive -y $package
            break
          else
            yay -S --noconfirm $package
          fi
        fi
        let "cnt-=1"
      done
      if ! pacman -Qqe | grep $pacname && [[ $_type != "flatpak" ]]; then
        log "There was a problem installing ${package}.  Please make sure this package exists."
      fi
    done
  else
    log "Warning! Passed variable is not an array".
  fi
}

log "installing commandline tools"
yay --noconfirm
install package extra/ranger
install package extra/kitty
install package aur/insync
install package extra/tmux
install package extra/virtualbox
install pacakge extra/audacity
install package omarchy/lmstudio
install pacakge extra/virtualbox-host-modules-arch
install package extra/telegram-desktop
install package extra/podman extra/buildah
install package extra/krita-plugin-gmic
install package extra/rsync
install package extra/lsof extra/strace
install package extra/gdb extra/ltrace
install package extra/htop extra/tree
install package extra/bind extra/openbsd-netcat extra/traceroute
install package extra/pdfarranger
install package aur/dosbox-staging
install package extra/nvidia extra/nvidia-settings extra/cuda
install package multilib/lib32-mesa multilib/lib32-vulkan-intel multilib/lib32-vulkan-radeon multilib/lib32-nvidia-utils
install package extra/gst-plugins-good extra/gst-plugins-bad extra/gst-plugins-ugly extra/gst-libav
install package extra/wine-staging multilib/winetricks
install package extra/git-lfs
install package extra/fs-uae
install package extra/tesseract extra/tesseract-data-eng
install package aur/inform7-ide aur/lectorte-bin
install package aur/hplip-plugin

# interactive fiction tools
# install package aur/inform7-ide-git
# install package aur/lectrote-bin

# codecs
install package extra/libaacs
install package extra/cdrtools extra/cdrdao extra/dvd+rw-tools

# syncterm
# NOTE: Had some issues with aur version
# thanks to MeaTLoTioN for this alternative script
# https://www.erb.pw/how-to-install-syncterm-for-linux-from-source/
mkdir -p ~/lab
cd ~/lab
curl -s https://erb.pw/get-syncterm.sh | bash

# Installing configuration
# # # # # # # # # # # # # # #
log "installing custom configuration"
bash -c "$(curl -fsSL https://raw.githubusercontent.com/odysseyalive/dotfiles/master/setup)"
bash ~/.yadrlite/setup omarchy

# Configure Starship prompt
log "configuring starship prompt"
mkdir -p ~/.config
cat >~/.config/starship.toml <<'EOF'
add_newline = true
command_timeout = 500
format = """
$directory
$username$time$git_branch$git_status$character"""

[character]
error_symbol = "[✗](bold red)"
success_symbol = "[❯](bold green)"

[directory]
truncation_length = 100
truncate_to_repo = false
style = "bold blue"
format = "[$path]($style)[$read_only]($read_only_style)"

[git_branch]
format = "[$symbol$branch]($style) "
style = "italic magenta"
symbol = ""

[git_status]
format = '[$all_status]($style)'
style = "yellow"
ahead = "⇡${count} "
diverged = "⇕⇡${ahead_count}⇣${behind_count} "
behind = "⇣${count} "
conflicted = " "
up_to_date = " "
untracked = "? "
modified = " "
stashed = ""
staged = ""
renamed = ""
deleted = ""

[username]
format = "[$user]($style) "
style_user = "bold green"
show_always = true

[time]
disabled = false
format = "[$time]($style) "
style = "bold cyan"
time_format = "%T"
EOF

# Configure Hyprland keyboard options
log "configuring hyprland keyboard settings"
if [ -f ~/.config/hypr/input.conf ]; then
  sed -i 's/^[[:space:]]*kb_options[[:space:]]*=.*/  kb_options = caps:swapescape/' ~/.config/hypr/input.conf
  # Reload Hyprland configuration if running
  if pgrep -x "Hyprland" >/dev/null; then
    hyprctl reload
    log "hyprland configuration reloaded"
  fi
fi

# Configure Hyprland Nvidia environment variables
log "configuring hyprland nvidia environment variables"
if [ -f ~/.config/hypr/hyprland.conf ]; then
  # Check if env variables are already set
  if ! grep -q "LIBVA_DRIVER_NAME,nvidia" ~/.config/hypr/hyprland.conf; then
    # Add Nvidia env variables at the beginning of the file
    sed -i '1i\# Nvidia environment variables\nenv = LIBVA_DRIVER_NAME,nvidia\nenv = GBM_BACKEND,nvidia-drm\nenv = __GLX_VENDOR_LIBRARY_NAME,nvidia\nenv = NVD_BACKEND,direct\n' ~/.config/hypr/hyprland.conf
    log "nvidia environment variables added to hyprland.conf"
    # Reload Hyprland configuration if running
    if pgrep -x "Hyprland" >/dev/null; then
      hyprctl reload
      log "hyprland configuration reloaded for nvidia settings"
    fi
  else
    log "nvidia environment variables already present in hyprland.conf"
  fi
fi

# improve sound
mkdir -p ~/.config/pipewire/pipewire.conf.d
printf "context.properties = {\n\
  default.clock.rate = 192000\n\
  default.clock.allowed-rates = [ 44100 48000 88200 96000 192000 352800 384000]\n\
}\n\
stream.properties = {\n\
  resample.quality = 10\n\
  channelmix.max-volume = 2.0\n\
}\n\
" >>~/.config/pipewire/pipewire.conf.d/10-rates.conf

# disables audio suspend for pipewire bug
mkdir -p ~/.config/wireplumber/main.lua.d/
cat >~/.config/wireplumber/main.lua.d/50-alsa-config.lua <<'EOF'
-- Disable suspend-on-idle for all audio devices
alsa_monitor.rules = {
  {
    matches = {
      {
        { "node.name", "matches", "alsa_output.*" },
      },
      {
        { "node.name", "matches", "alsa_input.*" },
      },
    },
    apply_properties = {
      ["session.suspend-timeout-seconds"] = 0,
    },
  },
}
EOF
sudo systemctl --user restart wireplumber

# configure swayosd max volume
mkdir -p ~/.config/swayosd
cat >~/.config/swayosd/config.toml <<'EOF'
[server]
show_percentage = true
max_volume = 200
style = "./style.css"
EOF

# clean everything
yay -Scc --noconfirm

log "Installation complete.  Please reboot your system."
printf "\r# # # # # # # # # # # # # # # # # # # # # # # # # # # # # #\r"
printf "ALL DONE\r"
printf "Review the workstation-installation.login and address any uninstalled packages noted.\r"
printf "PLEASE REBOOT YOUR SYSTEM."
