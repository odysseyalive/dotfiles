#!/usr/bin/env bash

# yadrlite
# Optimized Dotfiles
# # # # # # # # # # # # # # #

# # Options
# # # # # # # # # # # # # # #
USEREPO=yes
dir=~/.yadrlite
dotfiles_old=backup
action="${1:-install}"
declare -a files=('vim vimrc tmux.conf bash_profile bashrc vimrc.after')
declare -a config=('kitty nvim ranger')
declare -a tmuxplugins=('https://github.com/tmux-plugins/tmux-resurrect.git' 'https://github.com/tmux-plugins/tmux-sensible' 'https://github.com/wfxr/tmux-power.git')

# # Routines
# # # # # # # # # # # # # # #
function installed {
  local inststatus=yes
  if [[ $($1 2>&1) =~ (not found) ]]; then
    local inststatus=no
  fi
  echo "$inststatus"
}

function update {
  local dirs=$1
  cd $dirs
  local plugindirs=(*/)
  for pdir in "${plugindirs[@]}"; do
    cd $dirs/$pdir
    echo "Updating $pdir..."
    if [ -d ".git" ]; then
      git pull --rebase
    fi
  done
}

# # Remove
# # # # # # # # # # # # # # #
if [ "$action" == "remove" ]; then
  echo "# # Removing Dotfiles and Restoring Settings"
  echo "# # # # # # # # # # # # # # # # # # # # # #"
  for cfile in ${files[@]}; do
    rm -rf ~/.$cfile 2>/dev/null
    mv $dir/$dotfiles_old/.$cfile ~/ 2>/dev/null
  done
  for cfile in ${config[@]}; do
    rm -rf ~/.config/$cfile 2>/dev/null
    mv $dir/$dotfiles_old/config/$cfile ~/.config/$cfile 2>/dev/null
  done
  rm -rf $dir 2>/dev/null

  echo ""
  echo "Your original dotfiles have been restored.  Please restart"
  echo "the terminal or re-login to supress error messages."
  echo ""
fi

# # Update
# # # # # # # # # # # # # # #
if [ "$action" == "update" ]; then
  echo "# # Updating Dotfiles"
  echo "# # # # # # # # # # # # # # # # # # # # # #"
  if [ ! -f $dir/setup ]; then
    action=install
  else
    cd $dir
    git pull --rebase

    # Install/update tmux plugins
    echo "# # Updating tmux plugins"
    mkdir -p $dir/tmux/plugin
    mkdir -p ~/.tmux/plugins
    for tplug in "${tmuxplugins[@]}"; do
      plugname=$(basename $tplug .git)
      if [ ! -d "$dir/tmux/plugin/$plugname" ]; then
        echo "Installing $plugname..."
        git clone $tplug $dir/tmux/plugin/$plugname
      fi
    done
    update $dir/tmux/plugin

    # Install Starship if not present
    if ! command -v starship &>/dev/null; then
      echo "# # Installing Starship prompt"
      curl -sS https://starship.rs/install.sh | sh -s -- -y >/dev/null
    fi
    # Update Starship config
    mkdir -p ~/.config
    cp $dir/workstation/starship/starship.toml ~/.config/starship.toml
    # Add Starship init to bashrc if not already present
    if ! grep -q 'starship init bash' ~/.bashrc 2>/dev/null; then
      echo '' >>~/.bashrc
      echo '# Starship prompt' >>~/.bashrc
      echo 'eval "$(starship init bash)"' >>~/.bashrc
    fi

    echo ""
    echo "The update is finished."
  fi
fi

# nvm install v18.20.4
# # # # # # # # # # # # # # #
if [ "$action" == "tools" ]; then
  curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.3/install.sh | bash
  sleep 5
  export NVM_DIR="$HOME/.nvm"
  [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh" # This loads nvm
  nvm install v22.20.0
  sleep 5
  nvm alias default 22.20.0
  nvm use 22.20.0
  # Install pnpm for secure package management
  npm install -g pnpm
  [ -s "$HOME/.bashrc" ] && source "$HOME/.bashrc"
  pnpm setup
  pnpm install -g grunt-cli gulp gulp-cli csslint typescript typescript-language-server intelephense yaml-lint eslint-plugin-toml eslint-plugin-markdown golangci-lint vscode-css-languageserver-bin js-beautify unified-language-server eslint emmet-ls babel-eslint typescript-lsp coffeescript coffeelint neovim
  # go lang
  curl -sSL https://git.io/g-install | bash -s -- -y
  sleep 5
  export GOROOT="$HOME/.go"
  export PATH="$GOROOT/bin:$PATH"
  export GOPATH="$HOME/go"
  export PATH="$GOPATH/bin:$PATH"
  # Source the bashrc to ensure g is available
  [ -s "$HOME/.bashrc" ] && source "$HOME/.bashrc"
  g install latest
  go install github.com/junegunn/fzf@latest
  go install github.com/jesseduffield/lazygit@latest
  go install github.com/gitleaks/gitleaks/v8@latest
  go install github.com/charmbracelet/glow@latest

  # Install ripgrep and fd (pre-built binaries for Emacs consult)
  echo "# # Installing ripgrep and fd"
  mkdir -p ~/.local/bin
  export PATH="$HOME/.local/bin:$PATH"

  # Detect architecture
  ARCH=$(uname -m)
  case "$ARCH" in
  x86_64)
    ARCH_RG="x86_64"
    ARCH_FD="x86_64"
    ;;
  aarch64 | arm64)
    ARCH_RG="aarch64"
    ARCH_FD="aarch64"
    ;;
  *)
    echo "Unsupported architecture: $ARCH"
    ARCH_RG=""
    ;;
  esac

  if [ -n "$ARCH_RG" ]; then
    # ripgrep
    if ! command -v rg &>/dev/null; then
      RG_VERSION="14.1.1"
      curl -sL "https://github.com/BurntSushi/ripgrep/releases/download/${RG_VERSION}/ripgrep-${RG_VERSION}-${ARCH_RG}-unknown-linux-musl.tar.gz" | tar xz -C /tmp
      cp /tmp/ripgrep-${RG_VERSION}-${ARCH_RG}-unknown-linux-musl/rg ~/.local/bin/
      rm -rf /tmp/ripgrep-${RG_VERSION}-${ARCH_RG}-unknown-linux-musl
      echo "Installed ripgrep to ~/.local/bin"
    else
      echo "ripgrep already installed"
    fi

    # fd
    if ! command -v fd &>/dev/null; then
      FD_VERSION="10.2.0"
      curl -sL "https://github.com/sharkdp/fd/releases/download/v${FD_VERSION}/fd-v${FD_VERSION}-${ARCH_FD}-unknown-linux-musl.tar.gz" | tar xz -C /tmp
      cp /tmp/fd-v${FD_VERSION}-${ARCH_FD}-unknown-linux-musl/fd ~/.local/bin/
      rm -rf /tmp/fd-v${FD_VERSION}-${ARCH_FD}-unknown-linux-musl
      echo "Installed fd to ~/.local/bin"
    else
      echo "fd already installed"
    fi
  fi

  # Add ~/.local/bin to PATH in bashrc if not present
  if ! grep -q 'export PATH="$HOME/.local/bin' ~/.bashrc; then
    echo '' >>~/.bashrc
    echo '# Local binaries' >>~/.bashrc
    echo 'export PATH="$HOME/.local/bin:$PATH"' >>~/.bashrc
  fi

  # Install Nerd Font (required for Emacs doom-modeline and nerd-icons)
  echo "# # Installing Nerd Font"
  mkdir -p ~/.local/share/fonts
  cp $dir/workstation/fonts/*.ttf ~/.local/share/fonts/
  if command -v fc-cache &>/dev/null; then
    fc-cache -fv ~/.local/share/fonts
  fi

  # Install config files (kitty, nvim, ranger)
  echo "# # Installing config files (kitty, nvim, ranger)"
  echo "# # # # # # # # # # # # # # # # # # # # # # # # #"
  mkdir -p ~/.config
  mkdir -p $dir/backup/config 2>/dev/null
  for cfile in ${config[@]}; do
    # Backup existing config
    mv ~/.config/$cfile $dir/backup/config/$cfile 2>/dev/null
    # Copy new config
    cp -r $dir/workstation/$cfile ~/.config/$cfile
  done
  find ~/.config -type d -exec chmod 0755 {} \;
  find ~/.config -type f -exec chmod 0644 {} \;
  find ~/.config -name "*.sh" -execdir chmod u+x {} +

  # Install Starship prompt
  echo "# # Installing Starship prompt"
  curl -sS https://starship.rs/install.sh | sh -s -- -y >/dev/null
  cp $dir/workstation/starship/starship.toml ~/.config/starship.toml

  # Add Starship init to bashrc if not already present
  if ! grep -q 'starship init bash' ~/.bashrc; then
    echo '' >>~/.bashrc
    echo '# Starship prompt' >>~/.bashrc
    echo 'eval "$(starship init bash)"' >>~/.bashrc
  fi

fi

# nvm install v18.20.4
# # # # # # # # # # # # # # #
if [ "$action" == "omarchy" ]; then
  mise install node@22.20.0
  mise use -g node@22.20.0
  # Install pnpm for secure package management
  npm install -g pnpm
  [ -s "$HOME/.bashrc" ] && source "$HOME/.bashrc"
  pnpm setup
  # Source pnpm environment for current session
  export PNPM_HOME="$HOME/.local/share/pnpm"
  export PATH="$PNPM_HOME:$PATH"
  pnpm install -g grunt-cli gulp gulp-cli csslint typescript typescript-language-server intelephense yaml-lint eslint-plugin-toml eslint-plugin-markdown golangci-lint vscode-css-languageserver-bin js-beautify unified-language-server eslint emmet-ls babel-eslint typescript-lsp coffeescript coffeelint neovim

  # Install Fira Code Nerd Font
  echo "# # Installing Fira Code Nerd Font"
  mkdir -p ~/.local/share/fonts
  cp $dir/workstation/fonts/*.ttf ~/.local/share/fonts/

  # Install fontconfig (fixes Ghostty ligatures)
  echo "# # Installing fontconfig for ligature support"
  mkdir -p ~/.config/fontconfig
  cp $dir/workstation/fontconfig/fonts.conf ~/.config/fontconfig/
  fc-cache -fv

  # go lang
  curl -sSL https://git.io/g-install | bash -s -- -y
  sleep 5
  export GOROOT="$HOME/.go"
  export PATH="$GOROOT/bin:$PATH"
  export GOPATH="$HOME/go"
  export PATH="$GOPATH/bin:$PATH"
  # Source the bashrc to ensure g is available
  [ -s "$HOME/.bashrc" ] && source "$HOME/.bashrc"
  g install latest
  go install github.com/junegunn/fzf@latest
  go install github.com/jesseduffield/lazygit@latest
  go install github.com/gitleaks/gitleaks/v8@latest
  go install github.com/charmbracelet/glow@latest

  # Configure Kitty to use Omarchy theme system
  echo "# # Configuring Kitty for Omarchy theme switching"
  mkdir -p ~/.config/kitty
  cat >~/.config/kitty/kitty.conf <<'EOF'
# Omarchy theme integration - automatically updates when you switch themes
include ~/.config/omarchy/current/theme/kitty.conf

# Add your personal Kitty settings below this line
# (fonts, keybindings, window settings, etc.)

# Enable remote control for live theme switching (omarchy-theme-sync)
allow_remote_control yes
EOF

  # Configure Ghostty to use Omarchy theme system
  echo "# # Configuring Ghostty for Omarchy theme switching"
  mkdir -p ~/.config/ghostty
  cat >~/.config/ghostty/config <<'EOF'
# Ghostty Configuration for YADRLite + Omarchy
# https://ghostty.org

# Font settings
font-family = FiraCode Nerd Font
font-size = 10.5

# Terminal settings
term = xterm-256color

# Scrollback
scrollback-limit = 10000

# Clipboard
clipboard-read = allow
clipboard-write = allow

# Mouse
mouse-hide-while-typing = true

# Theme (synced from Omarchy)
# Run 'omarchy-theme-sync' after switching themes
EOF

  # Run theme sync to create Ghostty theme from Omarchy colors
  if [ -f ~/.config/omarchy/current/theme/kitty.conf ]; then
    bash $dir/workstation/scripts/omarchy-theme-sync.sh
    echo "  Ghostty configured with current Omarchy theme"
  else
    echo "  Ghostty base config installed (run 'omarchy-theme-sync' after setting theme)"
  fi

  # Install theme sync script
  mkdir -p ~/.local/bin
  chmod +x $dir/workstation/scripts/omarchy-theme-sync.sh
  ln -sf $dir/workstation/scripts/omarchy-theme-sync.sh ~/.local/bin/omarchy-theme-sync

  # Install Omarchy hook for automatic theme sync
  mkdir -p ~/.config/omarchy/hooks
  ln -sf $dir/workstation/scripts/omarchy-theme-sync.sh ~/.config/omarchy/hooks/theme-set
  echo "  Theme sync installed - runs automatically when you switch themes with 'omarchy theme'"

  # Install Starship prompt
  echo "# # Installing Starship prompt"
  curl -sS https://starship.rs/install.sh | sh -s -- -y >/dev/null
  mkdir -p ~/.config
  cp $dir/workstation/starship/starship.toml ~/.config/starship.toml

  # Install zoxide (smart cd command)
  echo "# # Installing zoxide"
  yay -S --noconfirm zoxide

  # Shell configuration - prefer zsh if installed, fallback to bash
  echo "# # Configuring shell"
  if command -v zsh &>/dev/null; then
    echo "  Zsh detected - configuring zsh with Starship"

    # Copy zshrc from dotfiles
    cp $dir/zsh/zshrc ~/.zshrc

    # Prompt user to change default shell
    echo ""
    echo "  Zsh is installed. To make it your default shell, run:"
    echo "    chsh -s \$(which zsh)"
    echo ""
  else
    echo "  Zsh not found - configuring bash with Starship"

    # Add Starship init to bashrc if not already present
    if ! grep -q 'starship init bash' ~/.bashrc; then
      echo '' >>~/.bashrc
      echo '# Starship prompt' >>~/.bashrc
      echo 'eval "$(starship init bash)"' >>~/.bashrc
    fi

    # Add zoxide to bash
    if ! grep -q 'zoxide init bash' ~/.bashrc; then
      echo '' >>~/.bashrc
      echo '# Zoxide (smart cd)' >>~/.bashrc
      echo 'eval "$(zoxide init bash)"' >>~/.bashrc
    fi

    echo ""
    echo "  TIP: Install zsh for a better shell experience:"
    echo "    sudo pacman -S zsh"
    echo "    Then re-run: bash ~/.yadrlite/setup omarchy"
    echo ""
  fi

  # Add custom plugins and settings to existing Omarchy Neovim setup
  echo "# # Adding custom plugins to Neovim (PHP, Copilot, org-mode, etc.)"
  mkdir -p ~/.config/nvim/lua/plugins
  mkdir -p ~/.config/nvim/lua/config

  # Copy specific custom plugin files (preserves stock omarchy plugins)
  declare -a custom_plugins=('coffeescript.lua' 'conform.lua' 'copilot-chat.lua' 'git.lua' 'mason.lua' 'nvim-dap.lua' 'org-mode.lua' 'performance.lua' 'php.lua' 'telescope.lua' 'vim-table-mode.lua')
  for plugin in "${custom_plugins[@]}"; do
    cp $dir/workstation/nvim/lua/plugins/$plugin ~/.config/nvim/lua/plugins/
  done

  # Update config files with custom settings
  cp $dir/workstation/nvim/lua/config/options.lua ~/.config/nvim/lua/config/options.lua
  cp $dir/workstation/nvim/lua/config/lazy.lua ~/.config/nvim/lua/config/lazy.lua

  # Configure uwsm to use Kitty as default terminal
  # (Kitty has better Linux support: drag-drop, ranger image previews)
  echo "# # Configuring Kitty as default terminal"
  if [ -f ~/.config/uwsm/default ]; then
    sed -i 's/^export TERMINAL=.*/export TERMINAL=kitty/' ~/.config/uwsm/default
    echo "  Updated TERMINAL export in ~/.config/uwsm/default"
  else
    echo "  Warning: ~/.config/uwsm/default not found"
  fi

  echo "Kitty set as default terminal"
fi

# # macOS Workstation Setup
# # # # # # # # # # # # # # #
if [ "$action" == "macos" ]; then
  echo "# # macOS Workstation Setup"
  echo "# # # # # # # # # # # # # # # # # # # # # #"

  # Verify macOS environment
  if [[ "$(uname)" != "Darwin" ]]; then
    echo "Error: This action is only for macOS systems."
    exit 1
  fi

  # Install Homebrew if not present
  if ! command -v brew &>/dev/null; then
    echo ""
    echo "Homebrew is the package manager for macOS and is required for this setup."
    echo "Learn more at: https://brew.sh"
    echo ""
    read -p "Install Homebrew now? (y/n) " -n 1 -r
    echo
    if [[ $REPLY =~ ^[Yy]$ ]]; then
      /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
      # Add Homebrew to PATH for current session
      if [[ -f "/opt/homebrew/bin/brew" ]]; then
        eval "$(/opt/homebrew/bin/brew shellenv)"
      elif [[ -f "/usr/local/bin/brew" ]]; then
        eval "$(/usr/local/bin/brew shellenv)"
      fi
    else
      echo "Cannot continue without Homebrew. Exiting."
      exit 1
    fi
  fi

  echo "# # Installing Homebrew packages"
  echo "# # # # # # # # # # # # # # # # # # # # # #"

  # Add taps
  brew tap nikitabobko/tap
  brew tap FelixKratz/formulae

  # Terminal and window management
  brew install --cask ghostty
  brew install --cask nikitabobko/tap/aerospace
  brew install sketchybar
  brew install borders

  # Development tools
  brew install neovim tmux ranger
  brew install git git-lfs
  brew install ripgrep fd fzf lazygit glow
  brew install php composer
  brew install python
  brew install go
  brew install w3m atool

  # Fonts
  # Cascadia Code for Ghostty (has working ligatures)
  # Nerd Font for LazyVim icons and Sketchybar
  brew install --cask font-cascadia-code
  brew install --cask font-caskaydia-cove-nerd-font

  # Node.js via mise (consistent with omarchy action)
  brew install mise
  mise install node@22.20.0
  mise use -g node@22.20.0

  # Source mise for current session
  eval "$(mise activate bash)"

  # Install pnpm for secure package management
  echo "# # Installing pnpm and development packages"
  echo "# # # # # # # # # # # # # # # # # # # # # #"
  npm install -g pnpm
  [ -s "$HOME/.zshrc" ] && source "$HOME/.zshrc"
  pnpm setup
  # Source pnpm environment for current session
  export PNPM_HOME="$HOME/Library/pnpm"
  export PATH="$PNPM_HOME:$PATH"

  # Install development packages via pnpm
  pnpm install -g grunt-cli gulp gulp-cli csslint typescript typescript-language-server intelephense yaml-lint eslint-plugin-toml eslint-plugin-markdown golangci-lint vscode-css-languageserver-bin js-beautify unified-language-server eslint emmet-ls babel-eslint typescript-lsp coffeescript coffeelint neovim

  # Go tools
  echo "# # Installing Go tools"
  echo "# # # # # # # # # # # # # # # # # # # # # #"
  export GOPATH="$HOME/go"
  export PATH="$GOPATH/bin:$PATH"
  go install github.com/junegunn/fzf@latest
  go install github.com/jesseduffield/lazygit@latest
  go install github.com/gitleaks/gitleaks/v8@latest
  go install github.com/charmbracelet/glow@latest

  echo "# # Configuring Ghostty"
  echo "# # # # # # # # # # # # # # # # # # # # # #"
  mkdir -p ~/.config/ghostty
  cp $dir/workstation/macos/ghostty/config ~/.config/ghostty/config

  # Set Ghostty as default terminal for shell scripts and executables
  echo "# # Setting Ghostty as default terminal"
  echo "# # # # # # # # # # # # # # # # # # # # # #"
  brew install duti
  # Set Ghostty as handler for shell scripts and public.unix-executable
  duti -s com.mitchellh.ghostty public.unix-executable all 2>/dev/null || true
  duti -s com.mitchellh.ghostty public.shell-script all 2>/dev/null || true
  duti -s com.mitchellh.ghostty .sh all 2>/dev/null || true
  duti -s com.mitchellh.ghostty .bash all 2>/dev/null || true
  duti -s com.mitchellh.ghostty .zsh all 2>/dev/null || true
  echo "  Ghostty set as default for shell scripts and executables"

  echo "# # Configuring AeroSpace"
  echo "# # # # # # # # # # # # # # # # # # # # # #"
  mkdir -p ~/.config/aerospace
  cp $dir/workstation/macos/aerospace/aerospace.toml ~/.config/aerospace/aerospace.toml

  echo "# # Configuring Sketchybar"
  echo "# # # # # # # # # # # # # # # # # # # # # #"
  mkdir -p ~/.config/sketchybar/plugins
  cp $dir/workstation/macos/sketchybar/sketchybarrc ~/.config/sketchybar/sketchybarrc
  cp $dir/workstation/macos/sketchybar/plugins/*.sh ~/.config/sketchybar/plugins/
  chmod +x ~/.config/sketchybar/sketchybarrc
  chmod +x ~/.config/sketchybar/plugins/*.sh

  echo "# # Configuring JankyBorders"
  echo "# # # # # # # # # # # # # # # # # # # # # #"
  mkdir -p ~/.config/borders
  cp $dir/workstation/macos/borders/bordersrc ~/.config/borders/bordersrc
  chmod +x ~/.config/borders/bordersrc

  echo "# # Installing Starship prompt"
  echo "# # # # # # # # # # # # # # # # # # # # # #"
  brew install starship
  cp $dir/workstation/starship/starship.toml ~/.config/starship.toml

  # Add Starship init to zshrc if not already present
  if ! grep -q 'starship init zsh' ~/.zshrc 2>/dev/null; then
    echo '' >>~/.zshrc
    echo '# Starship prompt' >>~/.zshrc
    echo 'eval "$(starship init zsh)"' >>~/.zshrc
  fi

  # Install zoxide (smart cd command)
  echo "# # Installing zoxide"
  brew install zoxide

  # Add zoxide to zsh
  if ! grep -q 'zoxide init zsh' ~/.zshrc 2>/dev/null; then
    echo '' >>~/.zshrc
    echo '# Zoxide (smart cd)' >>~/.zshrc
    echo 'eval "$(zoxide init zsh)"' >>~/.zshrc
  fi

  # Install tmux-power theme (if not already installed via tmuxplugins array)
  if [ ! -d "$dir/tmux/plugin/tmux-power" ]; then
    echo "# # Installing tmux-power theme"
    git clone https://github.com/wfxr/tmux-power.git $dir/tmux/plugin/tmux-power
  fi

  echo "# # Setting up SeaShells theme system"
  echo "# # # # # # # # # # # # # # # # # # # # # #"
  mkdir -p ~/.config/themes
  mkdir -p ~/.local/bin

  # Make theme switch script executable
  chmod +x $dir/workstation/macos/scripts/theme-switch.sh

  # Create symlink for easy access
  ln -sf $dir/workstation/macos/scripts/theme-switch.sh ~/.local/bin/theme-switch

  # Auto-detect system appearance and set initial theme
  bash $dir/workstation/macos/scripts/theme-switch.sh auto

  # Install LaunchAgent for automatic theme switching based on system appearance
  echo "# # Installing automatic theme watcher"
  mkdir -p ~/Library/LaunchAgents
  cp $dir/workstation/macos/scripts/com.yadrlite.theme-watcher.plist ~/Library/LaunchAgents/
  launchctl unload ~/Library/LaunchAgents/com.yadrlite.theme-watcher.plist 2>/dev/null || true
  launchctl load ~/Library/LaunchAgents/com.yadrlite.theme-watcher.plist

  echo "  Theme system installed with automatic light/dark mode switching!"
  echo "  Manual commands: 'theme-switch dark|light|toggle|auto'"

  echo "# # Setting up Caps Lock / Escape swap"
  echo "# # # # # # # # # # # # # # # # # # # # # #"

  # Create LaunchAgent to swap Caps Lock and Escape keys
  mkdir -p ~/Library/LaunchAgents
  cat >~/Library/LaunchAgents/com.local.KeyRemapping.plist <<'EOF'
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
    <key>Label</key>
    <string>com.local.KeyRemapping</string>
    <key>ProgramArguments</key>
    <array>
        <string>/usr/bin/hidutil</string>
        <string>property</string>
        <string>--set</string>
        <string>{"UserKeyMapping":[{"HIDKeyboardModifierMappingSrc":0x700000039,"HIDKeyboardModifierMappingDst":0x700000029},{"HIDKeyboardModifierMappingSrc":0x700000029,"HIDKeyboardModifierMappingDst":0x700000039}]}</string>
    </array>
    <key>RunAtLoad</key>
    <true/>
</dict>
</plist>
EOF

  # Apply the key swap immediately
  hidutil property --set '{"UserKeyMapping":[{"HIDKeyboardModifierMappingSrc":0x700000039,"HIDKeyboardModifierMappingDst":0x700000029},{"HIDKeyboardModifierMappingSrc":0x700000029,"HIDKeyboardModifierMappingDst":0x700000039}]}'

  echo "  Caps Lock and Escape keys swapped (persists across reboots)"

  echo "# # Installing config files (nvim, ranger)"
  echo "# # # # # # # # # # # # # # # # # # # # # #"
  mkdir -p ~/.config
  mkdir -p $dir/backup/config 2>/dev/null

  # Backup and install nvim config
  mv ~/.config/nvim $dir/backup/config/nvim 2>/dev/null
  cp -r $dir/workstation/nvim ~/.config/nvim

  # Backup and install ranger config
  mv ~/.config/ranger $dir/backup/config/ranger 2>/dev/null
  mkdir -p ~/.config/ranger
  cp -r $dir/workstation/ranger/* ~/.config/ranger/

  # Set proper permissions
  find ~/.config -type d -exec chmod 0755 {} \;
  find ~/.config -type f -exec chmod 0644 {} \;
  find ~/.config -name "*.sh" -execdir chmod u+x {} +

  echo "# # Configuring shell (zsh)"
  echo "# # # # # # # # # # # # # # # # # # # # # #"
  ZSHRC=~/.zshrc

  # Backup existing .zshrc
  if [ -f "$ZSHRC" ]; then
    cp "$ZSHRC" "$dir/backup/.zshrc"
  fi

  # Add YADRLite macOS configuration to .zshrc
  if ! grep -q "YADRLite macOS" "$ZSHRC" 2>/dev/null; then
    cat >>"$ZSHRC" <<'EOF'

# YADRLite macOS configuration
# Homebrew
eval "$(/opt/homebrew/bin/brew shellenv)" 2>/dev/null || eval "$(/usr/local/bin/brew shellenv)" 2>/dev/null

# mise (runtime manager)
eval "$(mise activate zsh)" 2>/dev/null

# pnpm
export PNPM_HOME="$HOME/Library/pnpm"
export PATH="$PNPM_HOME:$PATH"

# Go
export GOPATH="$HOME/go"
export PATH="$GOPATH/bin:$PATH"

# Local bin (theme-switch, etc.)
export PATH="$HOME/.local/bin:$PATH"

# Theme switch aliases
alias dark="theme-switch dark"
alias light="theme-switch light"
alias auto-theme="theme-switch auto"
EOF
    echo "Added YADRLite configuration to ~/.zshrc"
  fi

  echo ""
  echo "# # Starting services"
  echo "# # # # # # # # # # # # # # # # # # # # # #"
  echo ""
  echo "IMPORTANT: The following applications will request system permissions:"
  echo ""
  echo "1. AeroSpace - Accessibility (required for window management)"
  echo "2. Sketchybar - Accessibility (for menu bar integration)"
  echo ""
  echo "When prompted, go to System Settings > Privacy & Security > Accessibility"
  echo "and grant access to these applications."
  echo ""
  read -p "Press Enter to continue..."

  # Start AeroSpace (will prompt for accessibility permissions)
  if command -v aerospace &>/dev/null; then
    echo "Starting AeroSpace..."
    open -a AeroSpace
  fi

  # Start Sketchybar
  if command -v sketchybar &>/dev/null; then
    echo "Starting Sketchybar..."
    brew services start sketchybar
  fi

  # Start JankyBorders
  if command -v borders &>/dev/null; then
    echo "Starting JankyBorders..."
    brew services start borders
  fi

  echo ""
  echo "# # macOS Setup Complete"
  echo "# # # # # # # # # # # # # # # # # # # # # #"
  echo ""
  echo "Installed:"
  echo "  - Ghostty terminal (with SeaShells theme)"
  echo "  - AeroSpace tiling window manager (Alt+hjkl for navigation)"
  echo "  - Sketchybar status bar"
  echo "  - JankyBorders window borders"
  echo "  - Neovim with LazyVim configuration"
  echo "  - Ranger file manager"
  echo "  - Development tools (Node.js via mise, pnpm, Go tools)"
  echo ""
  echo "Please restart your terminal to apply all changes."
fi

# # Fix Omarchy Login Issues
# # # # # # # # # # # # # # #
if [ "$action" == "fix-omarchy-login" ]; then
  echo "# # Fixing Omarchy Login Issues"
  echo "# # # # # # # # # # # # # # # # # # # # # #"
  echo "This will mask Plymouth services and rebuild initramfs"
  echo ""

  # Mask Plymouth services to prevent them from starting
  echo "Masking Plymouth services..."
  sudo systemctl mask plymouth-start.service
  sudo systemctl mask plymouth-quit-wait.service

  # Rebuild initramfs without Plymouth hooks
  echo "Rebuilding initramfs without Plymouth hooks..."
  sudo mkinitcpio -P

  echo ""
  echo "Plymouth services have been masked and initramfs rebuilt."
  echo "System will reboot in 5 seconds..."
  sleep 5

  # Reboot the system
  sudo reboot
fi

# # Install
# # # # # # # # # # # # # # #
if [ "$action" == "install" ]; then
  echo "# # Installing Dotfiles"
  echo "# # # # # # # # # # # # # # # # # # # # # #"
  if [ -f $dir/setup ]; then
    echo ""
    echo "YADRLite is already installed."
    exit
  fi

  if ! [ -x "$(command -v git)" ]; then
    echo ""
    echo "'Git' doesn't seem to be installed.  Install it. :)"
    exit
  fi
  if [ "$USEREPO" == "yes" ]; then
    git clone https://github.com/odysseyalive/dotfiles.git $dir
  else
    if [ ! -f setup ]; then
      git clone https://github.com/odysseyalive/dotfiles.git $dir
    else
      cp -R . $dir
    fi
  fi

  echo "# # Backing up current configurations"
  echo "# # # # # # # # # # # # # # # # # # # # # #"
  cd $dir
  cat ~/.bashrc >$dir/bashrc 2>/dev/null
  cat ~/.bash_profile >$dir/bash_profile 2>/dev/null
  mkdir -p $dotfiles_old 2>/dev/null
  for cfile in ${files[@]}; do
    mv ~/.$cfile $dir/$dotfiles_old/ 2>/dev/null
  done

  echo "# # Vim and Tmux Configurations"
  echo "# # # # # # # # # # # # # # # # # # # # # #"
  cat $dir/vim/vimrc >>$dir/vimrc 2>/dev/null
  cat $dir/vim/vimrc.after >>$dir/vimrc.after 2>/dev/null
  cat $dir/tmux/tmux.conf >$dir/tmux.conf
  if [[ "$(uname)" == "Linux" || "$(uname)" == "FreeBSD" ]]; then
    echo "Gnu/Linux detected..."
  elif [[ "$(uname)" == "Darwin" ]]; then
    echo "macOS detected..."
    echo ""
    echo "Basic dotfiles installed. For complete macOS workstation setup, run:"
    echo "  bash ~/.yadrlite/setup macos"
    echo ""
  else
    rm -rf $dir
    echo "Your OS isn't supported. YADRLite supports Linux, FreeBSD, and macOS."
    exit
  fi

  echo "# # Loading plugins"
  echo "# # # # # # # # # # # # # # # # # # # # # #"
  mkdir $dir/tmux/plugin 2>/dev/null
  mkdir -p ~/.tmux/plugins 2>/dev/null
  cd $dir/tmux/plugin
  for tplug in "${tmuxplugins[@]}"; do
    echo "git clone $tplug"
    git clone $tplug
  done

  # covers injection into most existing configurations
  if ! grep -q "~/.bashrc" $dir/bash_profile && ! grep -q "~/.bash_profile" $dir/bashrc; then
    cat $dir/bash/bashrc >>$dir/bashrc 2>/dev/null
    echo "source ~/.bashrc" >>$dir/bash_profile 2>/dev/null
  elif ! grep -q "~/.bashrc" $dir/bash_profile; then
    cat $dir/bash/bashrc >>$dir/bash_profile 2>/dev/null
  else
    cat $dir/bash/bashrc >>$dir/bashrc 2>/dev/null
  fi

  # fixes sourcing of bashrc within tmux
  sed -i "s@.*\..*/etc/bashrc@    source /etc/bashrc@g" $dir/bashrc
  sed -i "s@.*\..*~\.bashrc@    source ~/.bashrc@g" $dir/bash_profile

  echo "# # Building Symbolic Links"
  echo "# # # # # # # # # # # # # # # # # # # # # #"
  cd $dir
  mkdir -p $dotfiles_old 2>/dev/null
  for cfile in ${files[@]}; do
    ln -s $dir/$cfile ~/.$cfile
  done

  echo ""
  echo "The dotfiles are installed!"
  echo ""
  echo "Next steps:"
  echo "  1. Install development tools:  bash ~/.yadrlite/setup tools"
  echo "  2. Restart your terminal"
  echo ""
  echo "For macOS workstation setup:  bash ~/.yadrlite/setup macos"
  echo "For Omarchy (Arch) setup:     bash ~/.yadrlite/setup omarchy"
  echo ""
fi
